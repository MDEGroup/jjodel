{"ast":null,"code":"import { DProject, DUser, LPointerTargetable, SetRootFieldAction, U } from '../../joiner';\nimport Storage from \"../../data/storage\";\nimport Api from \"../../data/api\";\nclass ProjectsApi {\n  static async create(type, name) {\n    let m2 = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : [];\n    let m1 = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : [];\n    let otherProjects = arguments.length > 4 ? arguments[4] : undefined;\n    // fix name\n    if (!otherProjects) {\n      let user = LPointerTargetable.fromPointer(DUser.current);\n      otherProjects = user.projects;\n    }\n    let allProjectNames = U.objectFromArray(otherProjects, p => p.name);\n    if (allProjectNames[name]) name = U.increaseEndingNumber(name, false, false, s => !!allProjectNames[s]);\n\n    // actually create the project\n    const project = DProject.new(type, name, undefined, m2, m1);\n    if (U.isOffline()) Offline.create(project);else await Online.create(project);\n    return project;\n  }\n  static async getAll() {\n    if (U.isOffline()) Offline.getAll();else await Online.getAll();\n  }\n  static async delete(project) {\n    if (U.isOffline()) Offline.delete(project.__raw);else await Online.delete(project.__raw);\n    project.delete();\n  }\n  static async getOne(id) {\n    if (U.isOffline()) return Offline.getOne(id);else return await Online.getOne(id);\n  }\n  static async save(project) {\n    if (!project) return;\n    SetRootFieldAction.new('_lastSelected', undefined);\n    if (U.isOffline()) await Offline.save(project.__raw);else await Online.save(project.__raw);\n  }\n}\nclass Offline {\n  static create(project) {\n    const projects = Storage.read('projects') || [];\n    projects.push(project);\n    Storage.write('projects', projects);\n  }\n  static getAll() {\n    const projects = Storage.read('projects') || [];\n    for (const project of projects) DProject.new(project.type, project.name, project.state, [], [], project.id);\n  }\n  static delete(project) {\n    const projects = Storage.read('projects') || [];\n    const filteredProjects = projects.filter(p => p.id !== project.id);\n    Storage.write('projects', filteredProjects);\n  }\n  static getOne(id) {\n    const projects = Storage.read('projects') || [];\n    let filtered = projects.filter(p => p.id === id);\n    if (filtered.length <= 0) return null;\n    return filtered[0];\n  }\n  static async save(project) {\n    const projects = Storage.read('projects') || [];\n    const filtered = projects.filter(p => p.id !== project.id);\n    const state = await U.compressedState();\n    Storage.write('projects', [...filtered, {\n      ...project,\n      state\n    }]);\n    alert('Saved');\n  }\n}\nclass Online {\n  static async create(project) {\n    await Api.post(`${Api.persistance}/projects`, {\n      id: project.id,\n      name: project.name,\n      type: project.type\n    });\n  }\n  static async getAll() {\n    const response = await Api.get(`${Api.persistance}/projects`);\n    if (response.code !== 200) {\n      /* 401: Unauthorized -> Invalid Token (Local Storage)  */\n      Storage.reset();\n      U.refresh();\n    }\n    const data = U.wrapper(response.data);\n    for (const project of data) DProject.new(project.type, project.name, project.state, [], [], project.id);\n  }\n  static async delete(project) {\n    await Api.delete(`${Api.persistance}/projects/${project.id}`);\n  }\n  static async getOne(id) {\n    const response = await Api.get(`${Api.persistance}/projects/${id}`);\n    if (response.code !== 200) return null;\n    return U.wrapper(response.data);\n  }\n  static async save(project) {\n    const state = await U.compressedState();\n    const response = await Api.patch(`${Api.persistance}/projects/${project.id}`, {\n      ...project,\n      state\n    });\n    if (response.code !== 200) alert('Cannot Save');else alert('Saved');\n  }\n}\nexport { ProjectsApi };","map":{"version":3,"names":["DProject","DUser","LPointerTargetable","SetRootFieldAction","U","Storage","Api","ProjectsApi","create","type","name","m2","arguments","length","undefined","m1","otherProjects","user","fromPointer","current","projects","allProjectNames","objectFromArray","p","increaseEndingNumber","s","project","new","isOffline","Offline","Online","getAll","delete","__raw","getOne","id","save","read","push","write","state","filteredProjects","filter","filtered","compressedState","alert","post","persistance","response","get","code","reset","refresh","data","wrapper","patch"],"sources":["C:/d/Programming/web/jodel-mde/src/api/persistance/projects.ts"],"sourcesContent":["import {\r\n    Dictionary,\r\n    DModel,\r\n    DProject, DUser,\r\n    LPointerTargetable,\r\n    LProject,\r\n    LUser,\r\n    Pointer,\r\n    SetRootFieldAction,\r\n    U\r\n} from '../../joiner';\r\nimport Storage from \"../../data/storage\";\r\nimport Api from \"../../data/api\";\r\n\r\nclass ProjectsApi {\r\n    static async create(type: DProject['type'], name: DProject['name'], m2: Pointer<DModel>[] = [], m1: Pointer<DModel>[] = [], otherProjects?: LProject[]): Promise<DProject> {\r\n\r\n        // fix name\r\n        if (!otherProjects) {\r\n            let user: LUser = LPointerTargetable.fromPointer(DUser.current);\r\n            otherProjects = user.projects;\r\n        }\r\n        let allProjectNames: Dictionary<string, LProject> = U.objectFromArray(otherProjects, (p)=>p.name);\r\n        if (allProjectNames[name]) name = U.increaseEndingNumber(name, false, false, (s)=>!!allProjectNames[s]);\r\n\r\n        // actually create the project\r\n        const project = DProject.new(type, name, undefined, m2, m1);\r\n        if(U.isOffline()) Offline.create(project);\r\n        else await Online.create(project);\r\n        return project;\r\n    }\r\n    static async getAll(): Promise<void> {\r\n        if(U.isOffline()) Offline.getAll();\r\n        else await Online.getAll();\r\n    }\r\n    static async delete(project: LProject): Promise<void> {\r\n        if(U.isOffline()) Offline.delete(project.__raw as DProject);\r\n        else await Online.delete(project.__raw as DProject);\r\n        project.delete();\r\n    }\r\n    static async getOne(id: DProject['id']): Promise<null|DProject> {\r\n        if(U.isOffline()) return Offline.getOne(id);\r\n        else return await Online.getOne(id);\r\n    }\r\n    static async save(project: LUser['project']): Promise<void> {\r\n        if(!project) return;\r\n        SetRootFieldAction.new('_lastSelected', undefined);\r\n        if(U.isOffline()) await Offline.save(project.__raw as DProject);\r\n        else await Online.save(project.__raw as DProject);\r\n    }\r\n}\r\n\r\nclass Offline {\r\n    static create (project: DProject): void {\r\n        const projects = Storage.read<DProject[]>('projects') || [];\r\n        projects.push(project);\r\n        Storage.write('projects', projects);\r\n    }\r\n    static getAll(): void {\r\n        const projects = Storage.read<DProject[]>('projects') || [];\r\n        for(const project of projects)\r\n            DProject.new(project.type, project.name, project.state, [], [], project.id);\r\n    }\r\n    static delete(project: DProject): void {\r\n        const projects = Storage.read<DProject[]>('projects') || [];\r\n        const filteredProjects = projects.filter(p => p.id !== project.id);\r\n        Storage.write('projects', filteredProjects);\r\n    }\r\n    static getOne(id: string): DProject|null {\r\n        const projects = Storage.read<DProject[]>('projects') || [];\r\n        let filtered: DProject|DProject[] = projects.filter(p => p.id === id);\r\n        if(filtered.length <= 0) return null;\r\n        return filtered[0];\r\n    }\r\n    static async save(project: DProject): Promise<void> {\r\n        const projects = Storage.read<DProject[]>('projects') || [];\r\n        const filtered = projects.filter(p => p.id !== project.id);\r\n        const state = await U.compressedState();\r\n        Storage.write('projects', [...filtered, {...project, state}]);\r\n        alert('Saved');\r\n    }\r\n}\r\n\r\nclass Online {\r\n    static async create (project: DProject): Promise<void> {\r\n        await Api.post(`${Api.persistance}/projects`, {\r\n           id: project.id,\r\n           name: project.name,\r\n           type: project.type\r\n        });\r\n    }\r\n    static async getAll(): Promise<void> {\r\n        const response = await Api.get(`${Api.persistance}/projects`);\r\n        if(response.code !== 200) {\r\n            /* 401: Unauthorized -> Invalid Token (Local Storage)  */\r\n            Storage.reset();\r\n            U.refresh();\r\n        }\r\n        const data = U.wrapper<DProject[]>(response.data);\r\n        for(const project of data)\r\n            DProject.new(project.type, project.name, project.state, [], [], project.id);\r\n    }\r\n    static async delete(project: DProject): Promise<void> {\r\n        await Api.delete(`${Api.persistance}/projects/${project.id}`);\r\n    }\r\n    static async getOne(id: string): Promise<DProject|null> {\r\n        const response = await Api.get(`${Api.persistance}/projects/${id}`);\r\n        if(response.code !== 200) return null;\r\n        return U.wrapper<DProject>(response.data);\r\n    }\r\n    static async save(project: DProject): Promise<void> {\r\n        const state = await U.compressedState();\r\n        const response = await Api.patch(`${Api.persistance}/projects/${project.id}`, {...project, state});\r\n        if(response.code !== 200) alert('Cannot Save');\r\n        else alert('Saved')\r\n    }\r\n}\r\n\r\nexport {ProjectsApi};\r\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}