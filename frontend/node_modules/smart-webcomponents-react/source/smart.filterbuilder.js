
/* Smart UI v9.4.16 (2021-07-17) 
Copyright (c) 2011-2021 jQWidgets. 
License: https://htmlelements.com/license/ */ //

Smart("smart-query-builder",class extends Smart.BaseElement{static get properties(){return{allowDrag:{value:!1,type:"boolean"},autoPrompt:{value:!1,type:"boolean"},applyMode:{allowValues:["immediately","change"],value:"change",type:"string"},customOperations:{value:[],type:"array",reflectToAttribute:!1},customOperators:{value:{},type:"object",reflectToAttribute:!1},dropDownWidth:{type:"any",value:"100%"},fields:{value:null,type:"array?",reflectToAttribute:!1},fieldsMode:{value:"dynamic",allowedValues:["dynamic","static"],type:"string"},formatStringDate:{value:"dd-MMM-yy",type:"string"},formatStringDateTime:{value:"dd-MMM-yy HH:mm:ss",type:"string"},getDynamicField:{value:null,type:"function?"},icons:{value:{"=":"equals","<>":"notequals",">":"greaterthan",">=":"greaterthanorequal","<":"lessthan","<=":"lessthanorequal",startswith:"startswith",endswith:"endswith",contains:"contains",notcontains:"notcontains",isblank:"isblank",isnotblank:"isnotblank"},type:"object",reflectToAttribute:!1},messages:{value:{en:{add:"Add",addCondition:"Add Condition",addGroup:"Add Group",and:"And",notand:"Not And",or:"Or",notor:"Not Or","=":"Equals","<>":"Does not equal",">":"Greater than",">=":"Greater than or equal to","<":"Less than","<=":"Less than or equal to",startswith:"Starts with",endswith:"Ends with",contains:"Contains",notcontains:"Does not contain",isblank:"Is blank",isnotblank:"Is not blank",wrongParentGroupIndex:'{{elementType}}: Wrong parent group index in "{{method}}" method.',wrongElementNode:'{{elementType}}: Incorect node / node Id in "{{method}}" method.',invalidDataStructure:"{{elementType}}: Used invalid data structure in updateCondition/updateGroup method.",dateTabLabel:"DATE",timeTabLabel:"TIME",queryLabel:"Query"}},type:"object",extend:!0},operatorPlaceholder:{value:"Operator",type:"string"},propertyPlaceholder:{value:"Property",type:"string"},showIcons:{value:!1,type:"boolean"},showFieldNameArrow:{value:!1,type:"boolean"},validateOnInput:{value:!1,type:"boolean"},validationTimeout:{value:100,type:"number"},value:{value:[],type:"any",reflectToAttribute:!1},valueFormatFunction:{value:null,type:"function?",reflectToAttribute:!1},valuePlaceholder:{value:"Value",type:"string"}}}static get requires(){const e={"Smart.Button":"smart.button.js","Smart.Calendar":"smart.calendar.js","Smart.CheckBox":"smart.checkbox.js","Smart.DateTimePicker":"smart.datetimepicker.js","Smart.DropDownList":"smart.dropdownlist.js","Smart.Input":"smart.input.js","Smart.ListBox":"smart.listbox.js","Smart.Menu":"smart.menu.js","Smart.NumericTextBox":"smart.numerictextbox.js","Smart.ScrollBar":"smart.scrollbar.js","Smart.TimePicker":"smart.timepicker.js","Smart.Tooltip":"smart.tooltip.js","Smart.Utilities.BigNumber":"smart.math.js","Smart.Utilities.DateTime":"smart.date.js","Smart.Utilities.Draw":"smart.draw.js","Smart.Utilities.NumericProcessor":"smart.numeric.js"};return window.NIComplex||(e["Smart.Utilities.Complex"]="smart.complex.js"),e}static get listeners(){return{down:"_downHandler",resize:"_resizeHandler","editorsContainer.keydown":"_editorsContainerKeydownHandler","editorsContainer.keyup":"_editorsContainerKeyUpHandler","conditionsMenu.close":"_menuCloseHandler","conditionsMenu.closing":"_menuClosingHandler","conditionsMenu.itemClick":"_menuItemClickHandler","contentContainer.change":"_contentContainerChangeHandler","contentContainer.itemClick":"_contentContainerChangeHandler","scrollableContainer.touchmove":"_scrollableContainerTouchmoveHandler","document.down":"_documentDownHandler","document.move":"_documentMoveHandler","document.up":"_documentUpHandler"}}static get styleUrls(){return["smart.querybuilder.css"]}template(){return'<div id="container" role="presentation">\n                    <smart-scroll-viewer id="scrollableContainer" class="smart-scrollable-container" animation="[[animation]]" right-to-left="[[rightToLeft]]">\n                        <div id="queryLabel" class="smart-query-builder-label smart-unselectable"></div>\n                        <div id="contentContainer" class="smart-content-container"></div>\n                    </smart-scroll-viewer>\n                    <div id="editorsContainer" class="smart-editors-container" role="presentation">\n                        <div id="customEditor" class="smart-custom-editor smart-hidden"></div>\n                    </div>\n                    <smart-menu id="conditionsMenu" mode="dropDown" class="smart-conditions-menu" theme="[[theme]]" animation="[[animation]]" right-to-left="[[rightToLeft]]"></smart-menu>\n                </div>'}propertyChangedHandler(e,t,i){super.propertyChangedHandler(e,t,i);const a=this;switch(e){case"animation":case"theme":["textBoxEditor","numericTextBoxEditor","comboBoxEditor","dateTimePickerEditor","checkBoxEditor"].forEach((t=>a.$[t]&&(a.$[t][e]=i)));break;case"formatStringDate":case"formatStringDateTime":case"valueFormatFunction":a._refresh();break;case"operatorPlaceholder":Array.from((a.shadowRoot||a).querySelectorAll(".smart-filter-operation[placeholder]")).forEach((e=>e.firstElementChild.innerHTML=i));break;case"propertyPlaceholder":Array.from((a.shadowRoot||a).querySelectorAll(".smart-filter-field-name[placeholder]")).forEach((e=>e.firstElementChild.innerHTML=i));break;case"showIcons":a._closeEditor(),i?a._filterOperationDescriptions.map((e=>e.icon=a.icons[e.value])):a._filterOperationDescriptions.map((e=>delete e.icon));break;case"customOperations":case"fields":case"value":{const t=JSON.stringify(a._validValue),o=a._queryParser;"customOperations"===e?a._handleCustomOperations():""===e&&a._mapFieldsToMenu(),a._applyValue(),"customOperations"!==e&&"fields"!==e||(o[e]=i),a._oldValueAsString!==t&&(a._oldValueAsString=t,a.$.fireEvent("change",{value:JSON.parse(t),linq:o.toLinq(a._validValue)}));break}case"valuePlaceholder":Array.from((a.shadowRoot||a).querySelectorAll(".smart-filter-value[placeholder]")).forEach((e=>e.firstElementChild.innerHTML=i));break;case"locale":case"messages":a._localizeInitialValues(),a._refresh(),a._handleCustomOperations(),a.$.dateTimePickerEditor&&(a.$.dateTimePickerEditor.messages[a.locale]||(a.$.dateTimePickerEditor.messages[a.locale]={}),a.$.dateTimePickerEditor.messages[a.locale].dateTabLabel=a.localize("dateTabLabel"),a.$.dateTimePickerEditor.messages[a.locale].timeTabLabel=a.localize("timeTabLabel"),"locale"===e?a.$.dateTimePickerEditor.locale=a.locale:"messages"===e&&(a.$.dateTimePickerEditor.$.selectDate.innerHTML=a.$.dateTimePickerEditor.messages[a.locale].dateTabLabel,a.$.dateTimePickerEditor.$.selectTime.innerHTML=a.$.dateTimePickerEditor.messages[a.locale].timeTabLabel));break;case"icons":a._closeEditor()}}ready(){super.ready();const e=this;e.$.queryLabel.id||(e.$.queryLabel.id=e.id+"Label"),e.setAttribute("role","dialog"),e.setAttribute("aria-labelledby",e.$.queryLabel.id),-1!==navigator.platform.toLowerCase().lastIndexOf("mac")&&e.$.contentContainer.classList.add("mac"),e._queryParser=new Smart.Utilities.QueryParser,e._setInitialValues(),e._handleCustomOperations(),e._applyValue(),Object.defineProperty(e,"value",{get:function(){return e.context===e?e.properties.value.value:e._validValue},set(t){e.updateProperty(e,e._properties.value,t)}})}getLinq(){const e=this;if(e._validValue)return e._queryParser.toLinq(e._validValue)}get validationStatus(){const e=this;return!e.isReady||void 0===e._validationStatus||e._validationStatus}_setInitialValues(){const e=this;e._autoScrollCoefficient=Smart.Utilities.Core.Browser.Firefox?4:Smart.Utilities.Core.Browser.Edge?8:2,e._isMobile=Smart.Utilities.Core.isMobile,e._manuallyAddedFields=[],e._localizeInitialValues(),e.$.conditionsMenu.dropDownAppendTo=e.$.container,e.$.conditionsMenu.dataSource=e._groupOperationDescriptions,e._valueFlat=[],e._lastProcessedItemInCurrentGroup={parentId:null,id:null,position:null}}_applyValue(){const e=this;e._emptyElementsStructure(!0),e._validateValue(),e._convertValueToFlat(e.value),e._getFieldsFromValue(),e._mapFieldsToMenu(),e._validateValueByType(),e._generateHTMLStructureFromFlatValue(!0),e._restrictNesting(),e._validValue=e._getValidValue(),e._oldValueAsString=JSON.stringify(e._validValue)}_validateValueByType(){const e=this;if(!e._valueFlat||!e._valueFlat.length)return;const t=e._valueFlat;for(let i=0;i<t.length;i++){const a=t[i];if("condition"!==a.type)continue;const o=a.data[0];!o||a.data.length<3||(a.data[2]=e._validateStoredValue(a.data[2],o))}e._generateValue(!0)}_setRequiredFields(){const e=this;if(!e.requiredFields||!e.requiredFields.length)return;const t=e.value;let i=[];for(let a=0;a<e.requiredFields.length;a++){const o=e.requiredFields[a],l=e.fields.find((e=>e.dataField===o));if(l){let e=[];if(t){let i=0;for(;i<t.length;){const a=t[i];if(Array.isArray(a)){let t=0;for(;t<a.length;){let i=a[t];i&&i[0]===l.dataField?(e.push(i),a.splice(t>0?t-1:t,2)):t++}}a.length?i++:t.splice(i,2)}}if(e)for(let t=0;t<e.length;t++)i.push(e[t]),i.push("and");else i.push([o]),i.push("and")}}"string"==typeof i[i.length-1]&&i.pop(),e.value.unshift(i,"and")}_contentContainerChangeHandler(e){const t=this,i=e.target,a=t.applyMode;if(e.stopPropagation(),"itemClick"===e.type&&i.value!==e.detail.label||"immediately"!==a||!t._editorIsOpen||!t._editor||"immediately"===a&&i!==t._editor)return;const o=t._editor.closest(".filter-builder-item");o.classList.contains("smart-filter-value")||(t._closeEditor(),t._handleAutoPrompt(o))}_handleAutoPrompt(e){const t=this;if(e&&t.autoPrompt&&"immediately"===t.applyMode&&!e.classList.contains("smart-filter-value")){const i=e.closest(".smart-filter-group-condition")||e.closest(".smart-filter-nested-operator")||e.closest(".smart-filter-group");if(!i)return;const a=t._getItemById(i.getAttribute("node-id")),o=i.querySelector(".smart-filter-value");if(!a||!o)return;t._clickHandlerFilterButton(e.classList,a.nodeId,o)}}_mapFieldsToMenu(){const e=this;(e.fields||e._valueFields)&&(e._fields=(e.fields||e._valueFields).concat(e._manuallyAddedFields).map((e=>({label:e.label,value:e.dataField,dataType:e.dataType,filterOperations:e.filterOperations,lookup:e.lookup}))))}_localizeInitialValues(){const e=this;e.$.queryLabel.innerHTML=e.localize("queryLabel"),e._addOptions=[{label:e.localize("addCondition"),value:"addCondition"},{label:e.localize("addGroup"),value:"addGroup"}],e._groupOperationDescriptions=[{label:e.localize("and"),value:"and"},{label:e.localize("or"),value:"or"}],e._defaultFilterOperationDescriptions=e._filterOperationDescriptions=[{label:e.localize("="),value:"=",custom:!1},{label:e.localize("<>"),value:"<>",custom:!1},{label:e.localize(">"),value:">",custom:!1},{label:e.localize(">="),value:">=",custom:!1},{label:e.localize("<"),value:"<",custom:!1},{label:e.localize("<="),value:"<=",custom:!1},{label:e.localize("startswith"),value:"startswith",custom:!1},{label:e.localize("endswith"),value:"endswith",custom:!1},{label:e.localize("contains"),value:"contains",custom:!1},{label:e.localize("notcontains"),value:"notcontains",custom:!1},{label:e.localize("isblank"),value:"isblank",custom:!1},{label:e.localize("isnotblank"),value:"isnotblank",custom:!1}];const t=Smart.Utilities.DateTime.getLocalizedNames(e.locale);e._localizedDays=t.days,e._localizedMonths=t.months}_handleCustomOperations(){const e=this;e._filterOperationDescriptions=e._defaultFilterOperationDescriptions.slice(0);for(let t=0;t<e.customOperations.length;t++){let i=e.customOperations[t],a=e._filterOperationDescriptions.findIndex((e=>e.value===i.name)),o={label:i.label,value:i.name,custom:!0,index:t,editorTemplate:i.editorTemplate,valueTemplate:i.valueTemplate,handleValue:i.handleValue,hideValue:i.hideValue,validateValue:i.validateValue};a>-1?e._filterOperationDescriptions[a]=o:e._filterOperationDescriptions.push(o)}}_editorsContainerKeydownHandler(e){const t=this;if(t._editorIsOpen&&("Escape"===e.key||"Enter"===e.key)){t._closeEditor();const e=t._editor.closest(".filter-builder-item");e&&!e.classList.contains("smart-filter-value")&&t._handleAutoPrompt(e)}}_editorsContainerKeyUpHandler(e){const t=this,i=t._editor;if(!(t._editor&&t._editor.contains(e.target)&&t._editorIsOpen&&t.validateOnInput))return;const a=t._editor.closest(".filter-builder-item"),o=t._editor.closest(".smart-filter-group-condition");a&&a.classList.contains("smart-filter-value")&&(clearTimeout(t._valueValidationTimeout),t._valueValidationTimeout=setTimeout((()=>{const e=o.getAttribute("node-id");clearTimeout(t._valueValidationTimeout),t._closeEditor(),t._generateValue();const a=t._getItemById(e);a&&(i.setAttribute("focus",""),t._openEditor(a.htmlNode.querySelector(".smart-filter-value"))),delete t._valueValidationTimeout}),t.validationTimeout))}_documentDownHandler(e){const t=this,i=t.shadowRoot||t.isInShadowDOM?e.originalEvent.composedPath()[0]:e.originalEvent.target;if(i.shadowParent&&i.shadowParent.closest(".smart-input-drop-down-menu")||i.closest(".smart-input-drop-down-menu")||t.$.conditionsMenu.contains(i))return;const a=i.closest(".smart-drop-down");if(i.getRootNode().host===t||i.closest("smart-query-builder")===t||a&&t.contains(a.ownerElement))if(t._isMobile){const i=t.$.scrollableContainer.scrollTop,a=t.getBoundingClientRect().top;setTimeout((function(){if(t.$.scrollableContainer.scrollTop===i&&t.getBoundingClientRect().top===a){const i=t.context;t.context=t,t._clickHandler(e.originalEvent),t.context=i}}),250)}else t._clickHandler(e.originalEvent);else t._editorIsOpen&&!t._scrollBarDown&&t._closeEditor(),delete t._scrollBarDown}_emptyElementsStructure(e){const t=this,i=t.$.contentContainer;for(;i.firstChild;)i.removeChild(i.firstChild);t._valueFlat=e?[]:t._valueFlat,t._lastProcessedItemInCurrentGroup={parentId:null,id:null,position:null}}_resizeHandler(){this.$.scrollableContainer.refresh()}_getTotalConditions(){return this.getElementsByClassName("smart-filter-group-condition").length}_parseLinqToValue(){const e=this,t=e._queryParser;t&&(t.customOperations=e.customOperations,t.fields=e.fields,t.dynamicField="dynamic"===e.fieldsMode?e.getDynamicField:void 0,e.set("value",t.toValue(e.value)))}_validateValue(){const e=this;"string"==typeof e.value&&e._parseLinqToValue();const t=e.value;if(Array.isArray(t)&&""!==JSON.stringify(t).replace(/[\[\]]/g,"")){for(3===t.length&&"string"==typeof t[0]&&(e.value=[[t]]),Array.isArray(t[0])&&3===t[0].length&&"string"==typeof t[0][0]&&(e.value=[t]);"string"==typeof t[0];)t.shift();for(;"string"==typeof t[t.length-1];)t.pop();e.value.forEach((e=>{Array.isArray(e)&&0===e.length&&e.push([])}))}else e.value=[[[]]]}_convertValueToFlat(e){const t=this,i=["and","or","notAnd","notOr"];if(!e)return;let a=0,o=0;t._valueFlat=[],function e(l,r){let n;for(let s=0;s<l.length;s++){const d=l[s];let c={htmlNode:null};if("string"==typeof d&&(i.indexOf(d)>-1||t.customOperators[d]))n=(t.customOperators[d]||d).trim();else if(n=n||"and",Array.isArray(d)){let i=t._valueFlat.filter((e=>e.parentId+""==r+"")).length;if(d.find((e=>Array.isArray(e))))c.nodeId=(o+=1)+"",c.type="group",c.data=n,t._valueFlat.push(c),e(d,c.nodeId),n="";else{if(t.maxConditions&&a>=t.maxConditions||t.maxConditionsPerGroup&&i>=t.maxConditionsPerGroup)continue;0!==s&&(t._valueFlat.push({nodeId:r+"."+i,type:"operator",data:n,parentId:r+""}),n="",i++),c.nodeId=r+"."+i,c.parentId=r+"",c.type="condition",c.data=d,a++,t._valueFlat.push(c)}}}}(e,0),delete t._totalGroups}_getFieldsFromValue(){const e=this._valueFlat,t=[],i=[];for(let o=0;o<e.length;o++){const l=e[o];if("condition"===l.type){const e=l.data[0];if(e&&-1===t.indexOf(e)){const o={label:e,dataField:e,dataType:(a=l.data[2],"boolean"==typeof a?"boolean":a instanceof Date?a.getHours()>0||a.getMinutes()>0||a.getSeconds()>0?"dateTime":"date":isNaN(a)?"string":"number"),format:null};t.push(e),i.push(o)}}}var a;this._valueFields=i}_addElement(e,t,i,a){const o=this,l=o._valueFlat.filter((e=>e.parentId===t));let r=0,n="";if(i=i||("group"===e?"or":[]),l.length){let e=l.map((e=>{const t=e.nodeId.split(".");return parseInt(t[t.length-1])}));e=0===e.length?[0]:e,r=e.reduce(((e,t)=>Math.max(e,t)))+1}t&&t.length>0&&(n=".");let s=(t||"")+n+("group"===e?o._valueFlat.filter((e=>"group"===e.type)).length+1:r),d=l[0];if(l.length)for(let e=0;e<l.length;e++){const t=l[e],i=t.nodeId.split(".").pop();parseInt(i)>parseInt(d.nodeId.split(".").pop())&&(d=t)}else d=o._valueFlat.find((e=>e.nodeId===t));let c=d?o._valueFlat.indexOf(d)+1:o._valueFlat.length;"condition"===e&&l.length>0&&(o._valueFlat.splice(c,0,{nodeId:s,parentId:t,type:"operator",data:["and"],htmlNode:null}),s=(t||"")+n+(r+1),c++);const u={nodeId:s,parentId:t,type:e,data:i,htmlNode:null},p=o.autoPrompt;if("condition"===e&&p&&o._fields.length){const e=o._fields[0];if(e){const t=o._getFilterOperations(e);i[0]=e.value||e.label||"",t.length&&(i[1]=t[0].value)}}if(o._valueFlat.splice(c,0,u),"group"===e&&o._addElement("condition",s,[],!0),!a&&(o._refresh(),p&&u.htmlNode)){const e=u.htmlNode,t=e.querySelector(".smart-filter-value");t&&o._clickHandlerFilterButton(e.classList,u.nodeId,t)}}_deleteElement(e,t){const i=this,a="string"==typeof e?e:e.getAttribute("node-id");if(a&&1!==a.length&&("group"===t?r(a):l(a),!t||"condition"===t)){let e=a.split(".");if(e.pop(),e=e.join("."),!i._valueFlat.filter((t=>t.parentId===e)).length&&(i._valueFlat.filter((e=>"group"===e.type)).length>1&&r(e),"0"===e)){const e=i._valueFlat.find((e=>"group"===e.type)),t=e.nodeId;e.nodeId="0",e.htmlNode.setAttribute("node-id","0");const a=i._valueFlat.filter((e=>e.parentId===t));for(let e=0;e<a.length;e++){const t=a[e];t.parentId="0",t.nodeId="0."+e,t.htmlNode.setAttribute("node-id",t.nodeId)}}i._generateValue()}function o(e){const t=i._valueFlat[e];if(t&&"operator"===t.type)return i._valueFlat.splice(e,1),t.htmlNode.parentElement.removeChild(t.htmlNode),!0}function l(e){let t,a=0,l=e.split(".");l.pop(),l=l.join(".");for(let o=0;o<i._valueFlat.length;o++){const r=i._valueFlat[o];if("condition"===r.type){if(r.nodeId===e){t=r;break}r.parentId===l&&a++}}const r=i._valueFlat.indexOf(t);i._valueFlat.splice(r,1),t.htmlNode.parentElement.removeChild(t.htmlNode);const n=o(r-1);a||o(r-(n?1:0));const s=i._valueFlat.filter((e=>e.nodeId===l))[0].htmlNode;s.children[1].childElementCount>0&&s.children[2].hasAttribute("limit-selection")&&!s.children[1].lastElementChild.hasAttribute("limit-selection")&&s.children[2].removeAttribute("limit-selection")}function r(e){const t=i._valueFlat.filter((t=>e===t.nodeId&&"group"===t.type))[0];for(let t=0;t<i._valueFlat.length;t++){const a=i._valueFlat[t],o=a.nodeId;a.parentId===e&&("group"===a.type?r(o):l(o))}i._valueFlat.indexOf(t)>-1&&i._valueFlat.splice(i._valueFlat.indexOf(t),1),t.htmlNode.parentElement.removeChild(t.htmlNode)}}_generateHTMLStructureFromFlatValue(e){const t=this,i=document.createDocumentFragment();if(t._valueFlat&&0!==t._valueFlat.length){for(let e=0;e<t._valueFlat.length;e++){const a=t._valueFlat[e],o=!!t.customOperations&&t.customOperations.find((e=>e.name===a.data[1])),l=a.parentId?(t.shadowRoot||t).querySelector('[node-id="'+a.parentId+'"]').querySelector(".smart-filter-group-condition-container"):t.$.contentContainer;if("group"===a.type){const o=document.createElement("div"),l=t.localize(a.data)||"";o.className="smart-filter-group",o.innerHTML='<div class="smart-filter-group-operator" role="button" aria-expanded="false" aria-haspopup="menu">'+l+'</div><div class="smart-filter-group-condition-container" role="group"></div><div class="smart-filter-add-condition-btn" role="button" aria-label="Add condition"><div>'+t.localize("add")+'</div></div><div class="smart-filter-add-btn" role="button" aria-expanded="false" aria-haspopup="menu" aria-label="Add group"></div>',o.firstElementChild.data=l,i.appendChild(o),o.setAttribute("node-id",a.nodeId),t._valueFlat[e].htmlNode=o}else if("condition"===a.type){const l=t._newFilterConditionRow(a.data);if(l.setAttribute("node-id",a.nodeId),i.appendChild(l),t._valueFlat[e].htmlNode=l,void 0!==a.data[0]&&void 0===a.data[1]){const e=t._getFilterOperations(t._fields.find((e=>e.value===a.data[0])));t._handleOnlyOperation(e,a.data,l)}else(-1!==["isblank","isnotblank"].indexOf(a.data[1])||o&&o.hideValue)&&(a.data.splice(2,1),l.children[2].classList.add("smart-visibility-hidden"))}else{const o=document.createElement("div");o.className="smart-filter-nested-operator",o.setAttribute("node-id",a.nodeId),o.setAttribute("role","button"),o.setAttribute("aria-expanded",!1),o.setAttribute("aria-haspopup","menu"),o.innerHTML=t.localize(a.data),i.appendChild(o),t._valueFlat[e].htmlNode=o}l.appendChild(i)}e&&t._validateValueAdvanced(),t.$.scrollableContainer.refresh()}}_validateValueAdvanced(){const e=this,t=e.value;let i=!1,a=!1,o=0;for(let e=0;e<t.length;e++){const l=t[e];if("string"!=typeof l)for(let e=l.length-1;e>=0;e--){let t=l[e];if(Array.isArray(t)&&0===t.length&&e!==l.length-1)l.splice(e,1),0===e&&l.splice(0,1),i=!0;else if("string"==typeof t){t=t.toLowerCase(),o++,(o>1||"and"!==t&&"or"!==t)&&(a=!0);continue}o=0}}i&&(e._emptyElementsStructure(!0),e._convertValueToFlat(e.value),e._generateHTMLStructureFromFlatValue()),a&&e._generateValue(!0)}_restrictNesting(){Array.from(this.getElementsByClassName("smart-filter-add-condition-btn")).forEach((e=>{const t=e.previousElementSibling.lastElementChild;t&&t.hasAttribute("limit-selection")&&e.setAttribute("limit-selection","")}))}_clickHandler(e){const t=this,i=t.shadowRoot||t.isInShadowDOM?e.composedPath()[0]:e.target;if(t.disabled||!i||!i.closest||!t._isMobile&&0!==e.button)return;if(t._scrollBarDown)return void delete t._scrollBarDown;const a=i.closest(".smart-drop-down"),o=t._editor&&t._editor.contains(i)||a&&(t._editor.contains(a.ownerElement)||t._editor===a.ownerElement)||i.closest(".smart-custom-editor");t._editor&&t._editorIsOpen&&!o&&t._closeEditor();const l=i.closest(".smart-filter-group-condition")||i.closest(".smart-filter-nested-operator")||i.closest(".smart-filter-group");if(!l)return;const r=t._getItemById(l.getAttribute("node-id"));if(!r)return;if(t.$.fireEvent("itemClick",{id:r.nodeId,type:r.type,data:r.data}),i.closest(".smart-filter-delete-btn"))return void t._clickHandlerDeleteButton(r.htmlNode);const n=i.closest(".smart-filter-add-btn")||i.closest(".smart-filter-add-condition-btn");if(n){const e=n.closest(".smart-filter-group").getAttribute("node-id");return void(n.classList.contains("smart-filter-add-condition-btn")&&(t.maxConditions&&t._getTotalConditions()<t.maxConditions||!t.maxConditions)?t._addElement("condition",e,[]):t._clickHandlerFilterButton(n.classList,r.nodeId,i))}const s=i.closest(".filter-builder-item")||i.closest(".smart-filter-group-operator")||i.closest(".smart-filter-nested-operator");if(s){const e=s.classList;t._clickHandlerFilterButton(e,r.nodeId,i)}}_downHandler(e){const t=this;if(!e.originalEvent||!t._isMobile&&0!==e.button)return;const i=t.shadowRoot||t.isInShadowDOM?e.originalEvent.composedPath()[0]:e.originalEvent.target,a=t.rightToLeft?e.pageX>i.getBoundingClientRect().right:e.pageX<i.getBoundingClientRect().left;if(t.allowDrag&&i.classList.contains("smart-filter-group-condition")&&a){const a=t._valueFlat.filter((e=>"condition"===e.type));if(1===a.length||2===a.length&&a[0].parentId===a[1].parentId&&a[1].htmlNode.hasAttribute("limit-selection"))return;return t._dragDetails={coords:{x:e.pageX,y:e.pageY},item:i,originalEvent:e},t.$.scrollableContainer._scrollView.disableSwipeScroll=!0,t._hoveredCondition=i,void window.getSelection().removeAllRanges()}this._scrollBarDown=i.closest("smart-scroll-bar"),e.stopPropagation(),e.preventDefault()}_scrollableContainerTouchmoveHandler(e){this._dragDetails&&e.cancelable&&(e.preventDefault(),e.stopPropagation())}_documentMoveHandler(e){const t=this,i=t._dragDetails;if(!i)return;const a=i.item;if(!i.feedbackShown){if(!(Math.abs(i.coords.x-e.pageX)>5||Math.abs(i.coords.y-e.pageY)>5))return;{const o=t._valueFlat.filter((e=>e.htmlNode===a))[0];if(t.$.fireEvent("dragStart",{data:o.data,item:a,originalEvent:e}).defaultPrevented)return delete t._dragDetails,delete t._hoveredCondition,void(t.$.scrollableContainer._scrollView.disableSwipeScroll=!1);i.allConditions=Array.from((t.shadowRoot||t).querySelectorAll(".smart-filter-group-condition")),i.data=o,i.feedback=t._addDragFeedback(),i.feedbackShown=!0,a.classList.add("dragged")}}const o=e.clientY;let l,r=t.shadowRoot||t.isInShadowDOM?e.originalEvent.composedPath()[0]:e.originalEvent.target;if(t.$.fireEvent("dragging",{data:i.data,item:a,originalEvent:e}),t.setAttribute("dragging",""),i.feedback.style.left=e.pageX+10+"px",i.feedback.style.top=e.pageY+10+"px",t._isMobile){const i=t._hoveredCondition;i&&(i.classList.remove("drop-target","top","bottom"),delete t._hoveredCondition);const a=document.elementFromPoint(e.clientX,o);a&&(r=a)}let n,s=r.closest(".smart-filter-group-condition");if(s){l=s;const e=l.getBoundingClientRect(),t=Math.abs(o-e.top),i=Math.abs(o-e.bottom);n=t<i?"top":"bottom"}else{let e,t;i.allConditions.forEach((i=>{const a=i.getBoundingClientRect(),l=Math.abs(o-a.top),r=Math.abs(o-a.bottom),s=Math.min(l,r);(void 0===t||s<t)&&(e=i,t=s,n=l<r?"top":"bottom")})),s=e}if(s===a||s.hasAttribute("limit-selection")&&"bottom"===n)s=void 0;else{const e=Array.from(s.parentElement.getElementsByClassName("smart-filter-group-condition")),t=e.indexOf(a);-1!==t&&("top"===n&&s===e[t+1]||"bottom"===n&&s===e[t-1])&&(s=void 0)}if(l=s,i.side=n,clearInterval(t._dragInterval),t._dragInterval=setInterval((function(){const i=t.getBoundingClientRect();t.$.scrollableContainer.scrollHeight>0&&i.left<=e.clientX&&i.left+i.width>=e.clientX?o>=i.top&&o<=i.top+36?t.$.scrollableContainer.scrollTop-=t._autoScrollCoefficient:o>=i.top+i.height-36&&o<=i.top+i.height?t.$.scrollableContainer.scrollTop+=t._autoScrollCoefficient:clearInterval(t._dragInterval):clearInterval(t._dragInterval)}),1),l){t._hoveredCondition&&l!==t._hoveredCondition&&t._hoveredCondition.classList.remove("drop-target","top","bottom");const e=l.closest(".smart-filter-group");if(e&&e.hasAttribute("restricted"))return void(t._hoveredCondition=void 0);t._hoveredCondition=l,l.classList.remove("top","bottom"),l.classList.add(n,"drop-target")}else t._hoveredCondition&&(t._hoveredCondition.classList.remove("drop-target","top","bottom"),delete t._hoveredCondition)}_addDragFeedback(){const e=this,t=document.createElement("div");return e.rightToLeft?t.setAttribute("right-to-left",""):t.removeAttribute("right-to-left"),t.className="smart-query-builder-drag-feedback",e.theme&&t.setAttribute("theme",e.theme),document.body.appendChild(t),t}_documentUpHandler(e){const t=this,i=t._dragDetails;if(!i)return void(t.$.conditionsMenu.opened&&t._selectedElement&&!t._selectedElement.classList.contains("smart-filter-add-btn")&&t.$.conditionsMenu._hoverViaKeyboard(t.$.conditionsMenu.querySelector('smart-menu-item[value="'+t._editedItem.data+'"]')));const a=i.item,o=i.data,l=t._hoveredCondition;if(delete t._dragDetails,delete t._hoveredCondition,t.$.scrollableContainer._scrollView.disableSwipeScroll=!1,!t.hasAttribute("dragging"))return;if(clearInterval(t._dragInterval),window.getSelection().removeAllRanges(),t.removeAttribute("dragging"),a.classList.remove("dragged"),i.feedback.remove(),!l)return void t.$.fireEvent("dragEnd",{data:o.data,item:a,originalEvent:e,target:null,targetData:null,targetSide:null});const r=t._valueFlat.filter((e=>e.htmlNode===l))[0],n=t.$.fireEvent("dragEnd",{data:o.data,item:a,originalEvent:e,target:l,targetData:r.data,targetSide:i.side});if(l.classList.remove("drop-target","top","bottom"),n.defaultPrevented)return;const s=t.value,d=o.nodeId.split(".").map((e=>parseFloat(e))),c=s[2*(d[0]-1)],u=r.nodeId.split(".").map((e=>parseFloat(e))),p=s[2*(u[0]-1)];let m="and";c.length>1&&(0===d[1]?(m=c[1],c[1]="!remove!"):(m=c[d[1]-1],c[d[1]-1]="!remove!")),c[d[1]]="!remove!","top"===i.side?p.splice(u[1],0,o.data,m):p.splice(u[1]+1,0,m,o.data);for(let e=0;e<s.length;e++)Array.isArray(s[e])&&(s[e]=s[e].filter((e=>"!remove!"!==e)));for(let e=s.length-1;e>=0;e--)Array.isArray(s[e])&&0===s[e].length&&(0===e?s.splice(0,2):(s.splice(e-1,2),e--));t._emptyElementsStructure(!0),t._convertValueToFlat(s),t._generateHTMLStructureFromFlatValue(),t._validValue=t._getValidValue();const f=JSON.stringify(t._validValue);t._oldValueAsString!==f&&(t._oldValueAsString=f,t.$.fireEvent("change",{value:JSON.parse(f),linq:t._queryParser.toLinq(t._validValue)}))}_clickHandlerDeleteButton(e,t){const i=this;if(e&&e.classList){if(i._closeEditor(),1===i.getElementsByClassName("smart-filter-group-condition").length){const e=i._valueFlat[1].htmlNode.children;i.value=[[[]]],i._validValue=i._getValidValue(),i._valueFlat[1].data=[],i._valueFlat[1].htmlNode.setAttribute("limit-selection",""),e[0].setAttribute("placeholder",""),e[1].setAttribute("placeholder",""),e[2].setAttribute("placeholder",""),e[2].removeAttribute("invalid-value"),e[0].firstElementChild.innerHTML=i.propertyPlaceholder,e[1].firstElementChild.innerHTML=i.operatorPlaceholder,e[2].firstElementChild.innerHTML=i.valuePlaceholder;const t=JSON.stringify(i._validValue);return i._oldValueAsString!==t&&(i._oldValueAsString=t,i.$.fireEvent("change",{value:JSON.parse(t),linq:i._queryParser.toLinq(i._validValue)})),void i._restrictNesting()}if(e.classList.contains("smart-filter-group")){if(t&&i._valueFlat.filter((t=>t.parentId===e.getAttribute("node-id"))).length>0)return;i._deleteElement(e,"group")}else i._deleteElement(e);i._generateValue(),i.$.scrollableContainer.refresh(),Array.from(i.$.contentContainer.children).forEach(((e,t)=>{const a=(t+1).toString();e.setAttribute("node-id",a),i._valueFlat.filter((t=>t.htmlNode===e))[0].nodeId=a,Array.from(e.children[1].children).forEach(((e,t)=>{const o=i._valueFlat.filter((t=>t.htmlNode===e))[0],l=a+"."+t;e.setAttribute("node-id",l),o.parentId=a,o.nodeId=l}))}))}}_menuCloseHandler(){const e=this.$.conditionsMenu.controlledBy;e.setAttribute("aria-expanded",!1),e.removeAttribute("aria-controls"),delete this.$.conditionsMenu.controlledBy}_menuClosingHandler(e){const t=e.detail;"interaction"===t.trigger&&this._selectedElement===t.target&&e.preventDefault()}_menuItemClickHandler(e){const t=this,i=t._selectedElement.closest(".smart-filter-group-operator, .smart-filter-nested-operator"),a=e.detail,o=a.value;let l;if(i){i.innerHTML=t.localize(o)||a.label,i.value=o,l=i.classList.contains("smart-filter-nested-operator")?i.getAttribute("node-id"):i.parentElement.getAttribute("node-id");for(let e=0;e<t._valueFlat.length;e++)if(t._valueFlat[e].nodeId===l){t._valueFlat[e].data=i.value;break}t._generateValue()}else l=t._selectedElement.parentElement.getAttribute("node-id"),t._addElement("group",null,o);t.$.scrollableContainer.refresh()}_newFilterConditionRow(e=[]){const t=this,i=e[0];let a,o=t._fields.find((e=>e.value===i)),l=o?o.label:void 0;void 0===i||!l&&"static"===t.fieldsMode?e.length=0:(l||(o=t._getDynamicFieldInfo(i),l=o.label,e[0]=o.dataField),a=t._getFilterOperations(o).find((t=>t.value===e[1])),a&&(a=a.label));const r=t._formatValueStringRepresentation(e[2],e),n=t._validateValueField(void 0,e[1],e[2]);let s=document.createElement("div"),d="condition"+Math.floor(65536*(1+Math.random())).toString(16).substring(1),c='<div class="filter-builder-item smart-filter-field-name" id="'+d+'Field" '+(l?'><div class="smart-value-container" role="presentation">'+l:'placeholder><div class="smart-value-container" role="presentation">'+t.propertyPlaceholder)+'</div></div><div class="filter-builder-item smart-filter-operation" id="'+d+'Operation" '+(a?'><div class="smart-value-container" role="presentation">'+a:'placeholder><div class="smart-value-container" role="presentation">'+t.operatorPlaceholder)+'</div></div><div class="filter-builder-item smart-filter-value" id="'+d+'Value" '+(n?"":"invalid-value")+(void 0!==e[2]?'><div class="smart-value-container" role="presentation">'+r:'placeholder><div class="smart-value-container" role="presentation">'+t.valuePlaceholder)+'</div></div><div class="smart-filter-delete-btn" role="button" aria-label="Close"></div>';return s.className="smart-filter-group-condition",s.setAttribute("role","group"),s.innerHTML=c,t._setAriaLabel(s),e.length||s.setAttribute("limit-selection",""),s}_setAriaLabel(e){const t=[];for(let i=0;i<e.children.length-1;i++){const a=e.children[i];a.classList.contains("smart-visibility-hidden")||a.hasAttribute("placeholder")||t.push(e.children[i].innerText)}0!==t.length?e.setAttribute("aria-label",t.join(" ")):e.setAttribute("aria-label","Empty condition row")}_formatValueStringRepresentation(e,t){const i=this,a=t[2],o=t[0],l=i._getFieldByFieldName(o);let r,n=t[1];if(!l)return e;if(null==e)return i.valuePlaceholder;if(void 0!==n&&i.customOperations&&i.customOperations.length>0&&(n=i.customOperations.find((e=>e.name===n)),n&&n.valueTemplate))return"<span>"+n.valueTemplate(i._editor,e)+"</span>";switch(l.dataType.toLowerCase()){case"date":case"datetime":(e=e instanceof Date||"string"==typeof e||"number"==typeof e&&!isNaN(e)?new Smart.Utilities.DateTime(e):e).calendar.days=i._localizedDays,e.calendar.months=i._localizedMonths,e.calendar.locale=i.locale,r=e.toString("date"===l.dataType?i.formatStringDate:i.formatStringDateTime);break;case"array":r="string"==typeof e?e.split(","):e;break;case"object":r="string"==typeof e?e:JSON.stringify(e);break;case"number":r=e;break;case"boolean":r=!!e;break;default:r=e+""}if(!i.valueFormatFunction)return"<span>"+r+"</span>";const s={label:r,value:a,dataField:o,dataType:l.dataType||"string"};return"<span>"+i.valueFormatFunction(s)+"</span>"}_getFieldByFieldName(e){return Object.assign({},this._fields.find((t=>t.value===e)))}_refresh(){const e=this;e._generateValue(),e._emptyElementsStructure(),e._generateHTMLStructureFromFlatValue(),e._restrictNesting()}_generateValue(e){const t=this;let i=[],a=t._valueFlat.slice(0),o=[];for(let e=0;e<a.length;e++){const t=a[e];let o={};"group"===t.type&&(o.nodeId=t.nodeId,o.parentId=t.parentId,o.data=t.data,o.structure=[],i.push(o))}for(let e=0;e<i.length;e++){const t=i[e];for(let e=0;e<a.length;e++){const i=a[e];if(i.parentId===t.nodeId&&"condition"===i.type){const o=a[e-1];o&&o.parentId===t.nodeId&&"operator"===o.type&&t.structure.push(o.data.toString()),t.structure.push(i.data)}}}i=i.filter((e=>e.structure.length>0)),i.sort((function(e,t){return t.nodeId.split(".").length-e.nodeId.split(".").length}));for(let e=0;e<i.length;e++){const t=i[e],a=i.filter((e=>e.nodeId===t.parentId))[0];a&&a.structure?a.structure.push(t.structure):"0"!==t.nodeId?t.data&&(e>0&&o.push(t.data),o.push(t.structure)):o=o.concat(t.structure)}if(t.value=o,t._validateValue(),t._validValue=t._getValidValue(),t._updateValidationStatus(),!e){const e=JSON.stringify(t._validValue);t._oldValueAsString!==e&&(t._oldValueAsString=e,t.$.fireEvent("change",{value:JSON.parse(e),linq:t._queryParser.toLinq(t._validValue)}))}}_updateValidationStatus(){const e=this,t=e.customOperations.filter((e=>"function"==typeof e.validateValue)),i=e._valueFlat,a=!!e._validationStatus;let o=!0;for(let e=0,a=i.length;e<a;e+=1){const a=i[e];if("condition"!==a.type)continue;const l=a.data[1],r=t.find((e=>e.name===l));if(r&&0==!!r.validateValue(a.data[2])){o=!1;break}}if(e._validationStatus!==o){const t=void 0!==e._validationStatus;e._validationStatus=o,t&&e.$.fireEvent("validationChange",{oldValue:a,newValue:o})}}_getItemById(e,t){const i=this._valueFlat.filter((i=>t?i.parentId===e:i.nodeId===e));return i.length>0?i[0]:null}_validateStoredValue(e,t){const i=this;if(!t&&!i._editedItem)return e;if(!t&&!(t=i._editedItem.data[0]))return e;const a=i._getFieldByFieldName(t).dataType;if(void 0===a)return e+"";switch(a.toLowerCase()){case"date":case"datetime":e=new Smart.Utilities.DateTime(e).toDate();break;case"number":"number"!=typeof e&&(e=parseFloat(e));break;case"boolean":"boolean"!=typeof e&&(e=!!e);break;case"object":"object"!=typeof e&&(e={});break;case"array":Array.isArray(e)||(e=[e]);break;default:"string"!=typeof e&&(e+="")}return e}_closeEditor(e){const t=this;let i;if(!t._editedItem||!t._editorIsOpen)return;const a=t._editedItem,o=t._editor.closest(".filter-builder-item"),l=o.querySelector(".smart-value-container"),r=o.parentElement,n=r.children[2];if(t._editor===t.$.dateTimePickerEditor)t._editor._inputChangeHandler(),i=t._editor.value,i&&(i=i.toDate());else if(t._editor===t.$.checkBoxEditor)i=t._editor.checked;else if(t._editor===t.$.customEditor)t._editor&&Array.from(t._editor.getElementsByTagName("smart-numeric-text-box")).forEach((e=>e._inputBlurHandler())),i=t._validateStoredValue(t._selectedCustomCondition.handleValue(t._editor));else if(t._editor===t.$.numericTextBoxEditor)t._editor._inputBlurHandler(),i=t._editor.value;else if(o.classList.contains("smart-filter-value")){const e=t._getFieldByFieldName(t._editedItem.data[0]);if("array"===e.dataType)i=t._editor.value.split(",");else if("object"===e.dataType)i=JSON.parse(t._editor.value);else{const a=t._editor.value;i=e.lookup&&e.lookup.dataSource?{label:a,value:t._editor.dataset.value||a}:a}}else i=t._editor.value;if(o.classList.contains("smart-filter-field-name")){if(""===i.trim())return void t._hideEditor(o,void 0===a.data[0]);r.hasAttribute("limit-selection")&&(r.removeAttribute("limit-selection"),r.parentElement.nextElementSibling.removeAttribute("limit-selection"));const e=t._fields.find((e=>e.label===i)),s=a.data[0];if(e)a.data[0]=e.value;else{if("dynamic"!==t.fieldsMode){const e=t._fields.find((e=>e.value===s));return e&&(l.innerHTML=e.label),void t._hideEditor(o)}{const e=t._getDynamicFieldInfo(i);i=e.label,a.data[0]=e.dataField}}l.innerHTML=i,t._handleFieldChange([s,a.data[0]],[n,a,r])}else if(o.classList.contains("smart-filter-operation"))t._handleOperationChange([a,i,t._editor.$.input.dataValue],[l,n]);else{let e,o;"object"==typeof i&&void 0!==i.value?(e=i.label,o=i.value,void 0===e&&(e=o)):e=o=i,a.data[2]=o,l.innerHTML=t._formatValueStringRepresentation(e,a.data)}t._validateValueField(n,a.data[1],a.data[2]),t._generateValue(e),t._hideEditor(o)}_validateValueField(e,t,i){const a=this.customOperations;let o=!0;if(e&&e.removeAttribute("invalid-value"),a&&a.length>0){const l=a.find((e=>e.name===t));l&&"function"==typeof l.validateValue&&(o=!!l.validateValue(i),!o&&e&&e.setAttribute("invalid-value",""))}return o}_getDynamicFieldInfo(e){const t=this,i={label:e,dataField:e,dataType:"string"};if(t.getDynamicField){const a=t.getDynamicField(e);a.label&&(i.label=a.label),a.dataField&&(i.dataField=a.dataField),a.dataType&&(i.dataType=a.dataType),a.filterOperations&&Array.isArray(a.filterOperations)&&a.filterOperations.length>0&&(i.filterOperations=a.filterOperations),a.lookup&&(i.lookup=a.lookup)}return t._manuallyAddedFields.push(i),t._mapFieldsToMenu(),i}_handleFieldChange(e,t){const i=this,a=e[0],o=t[1],l=t[2],r=t[0],n=i._fields.find((t=>t.value===e[1])),s=i._getFilterOperations(n),d=function(){n.value!==a&&i.$.fireEvent("propertySelected",{label:n.label,value:n.value})};if(!a||void 0===o.data[1])return i._handleOnlyOperation(s,o.data,l),void d();const c=i._fields.find((e=>e.value===a)),u=c.dataType,p=n.dataType;if(n!==c&&(p!==u||"enum"===p||n.filterOperations||c.filterOperations)){if(s.find((e=>e.value===o.data[1]))){if(p===u&&"enum"!==p)return;return"date"===p&&"dateTime"===u||"dateTime"===p&&"date"===u?(r.firstElementChild.innerHTML=i._formatValueStringRepresentation(o.data),void d()):(o.data.splice(2,1),r.setAttribute("placeholder",""),r.firstElementChild.innerHTML=i.valuePlaceholder,void d())}o.data.splice(1,2),l.children[1].setAttribute("placeholder",""),l.children[1].firstElementChild.innerHTML=i.operatorPlaceholder,r.setAttribute("placeholder",""),r.firstElementChild.innerHTML=i.valuePlaceholder,r.classList.remove("smart-visibility-hidden"),i._handleOnlyOperation(s,o.data,l),d()}}_handleOnlyOperation(e,t,i){const a=this.autoPrompt;if(1===e.length||a&&"immediately"===this.applyMode&&e.length>1){const a=e[0];t[1]=a.value,i.children[1].removeAttribute("placeholder",""),i.children[1].firstElementChild.innerHTML=e[0].label,("isblank"===a.value||"isnotblank"===a.value||a.custom&&a.hideValue)&&(t.splice(2,1),i.children[2].classList.add("smart-visibility-hidden"))}}_handleOperationChange(e,t){const i=this,a=e[0],o=e[1],l=e[2],r=t[0],n=t[1],s=void 0!==a.data[1]?i._filterOperationDescriptions.find((e=>e.value===a.data[1])):void 0,d=i._filterOperationDescriptions.find((e=>e.value===l));if(!d||d===s)return;const c=a.data[0],u=a.data[1],p=a.data[2],m=d.value;if(a.data[1]=m,r.innerHTML=o,"isblank"===m||"isnotblank"===m||d.custom&&d.hideValue)a.data.splice(2,1),n.classList.add("smart-visibility-hidden");else if(n.classList.contains("smart-visibility-hidden"))n.setAttribute("placeholder",""),n.classList.remove("smart-visibility-hidden"),n.firstElementChild.innerHTML=i.valuePlaceholder;else if(d.custom){const e=i._getFieldByFieldName(c);if(d.editorTemplate){const t=d.editorTemplate(e.dataType,u,e);t&&(i.$.customEditor.innerHTML="",i.$.customEditor.appendChild(t))}d.valueTemplate?n.firstElementChild.innerHTML=d.valueTemplate(i.$.customEditor,p):void 0===p?(n.setAttribute("placeholder",""),n.firstElementChild.innerHTML=i.valuePlaceholder):n.firstElementChild.innerHTML=p}else void 0===p?(a.data.splice(2,1),n.setAttribute("placeholder",""),n.firstElementChild.innerHTML=i.valuePlaceholder):d.custom||(n.firstElementChild.innerHTML=i._formatValueStringRepresentation(p,a.data))}_hideEditor(e,t){const i=this;t&&e.setAttribute("placeholder",""),e.removeAttribute("edited"),i.$.editorsContainer.removeAttribute("open"),i._editor.close&&i._editor.close(),i._editor.classList.add("smart-hidden"),i._editorIsOpen=i._enterIsPressedInEditor=!1,i.$.scrollableContainer.refresh(),i._setAriaLabel(e.parentElement)}_clickHandlerFilterButton(e,t,i){const a=this;function o(e,t,i){a._contextMenuOptions=0===t.length?a._defaultFilterOperationDescriptions:t,a._handleContextMenu(e),a.$.conditionsMenu.opened&&(a.$.conditionsMenu._discardKeyboardHover(),a.$.conditionsMenu._hoverViaKeyboard(a.$.conditionsMenu.querySelector('smart-menu-item[value="'+i+'"]')))}i.closest(".smart-editors-container")||(a._closeEditor(),a._editedItem=a._getItemById(t),e.contains("smart-filter-add-btn")?o(i,a._groupOperationDescriptions):(e.contains("smart-filter-field-name")||a._editedItem.data&&a._editedItem.data.length)&&(e.contains("smart-filter-group-operator")||e.contains("smart-filter-nested-operator")?o(i,a._groupOperationDescriptions,a._editedItem.data):(i.closest(".filter-builder-item").removeAttribute("placeholder"),a._openEditor(i))))}_handleContextMenu(e){const t=this;if(t._selectedElement===e&&t.$.conditionsMenu.opened)return void t.$.conditionsMenu.close();if(t._closeEditor(),t.disableContextMenu)return void(t._selectedElement=e);const i=e.getBoundingClientRect(),a=t.getBoundingClientRect(),o=i.left+t.$.contentContainer.scrollLeft-a.left,l=i.top+t.$.contentContainer.scrollTop-a.top+i.height;e.hasAttribute("aria-haspopup")&&(t.$.conditionsMenu.controlledBy&&(t.$.conditionsMenu.controlledBy.setAttribute("aria-expanded",!1),t.$.conditionsMenu.controlledBy.removeAttribute("aria-controls")),e.setAttribute("aria-controls",t.$.conditionsMenu.id),e.setAttribute("aria-expanded",!0),t.$.conditionsMenu.controlledBy=e),t.$.conditionsMenu.dataSource=t._contextMenuOptions,t.$.conditionsMenu.open(o,l+3),t._selectedElement=e,t.$.scrollableContainer.refresh()}_openEditor(e){const t=this,i=e&&e.closest(".smart-filter-group-condition")?e.closest(".smart-filter-group-condition").getAttribute("node-id"):null,a=e.closest(".filter-builder-item"),o=t._getItemById(i);let l="";void 0!==o.data[0]?l=o.data[0]:t._fields.length&&(l=t._fields[0].value);let r,n,s=t._getFieldByFieldName(l),d="";if(a.classList.contains("smart-filter-field-name"))n=0,t._fields||t._mapFieldsToMenu(),s.lookup={dataSource:t._fields.slice(),readonly:!1},d=s.label||"",r=s.value;else if(a.classList.contains("smart-filter-operation")){n=1;let e=t._getFilterOperations(s);s.lookup={dataSource:e,readonly:!0};let i=e.find((e=>e.value===o.data[n]))||e[0];d=i.label,r=i.value}else n=2,d=o.data[n],void 0===d&&(d="");t._editorIsOpen&&t._closeEditor(),a.setAttribute("edited",""),t._editedItem=o;const c=t._fields.filter((e=>e.value===l)),u=t._filterOperationDescriptions.filter((e=>e.value===o.data[1]&&e.custom)),p=c.length>0?c[0]:null,m=s.lookup&&s.lookup.dataSource?"lookup":p?p.dataType:void 0;2===n&&0!==u.length&&u[0].editorTemplate?(t._selectedCustomCondition=u[0],t._openCustomEditor(m,d,s)):t._openEditorByFieldType(m,d,s,r),a.appendChild(t.$.editorsContainer),t._editor.classList.remove("smart-hidden"),t._editorIsOpen=!0,t.$.editorsContainer.setAttribute("open",""),t.$.scrollableContainer.refresh(),t._editor.classList.contains("smart-custom-editor")||requestAnimationFrame((()=>t._editor.focus())),s.lookup&&t._editor.open()}_getFilterOperations(e){const t=this;let i=t._filterOperationDescriptions.slice();if(e.filterOperations)i=t._filterOperationDescriptions.filter((t=>e.filterOperations.indexOf(t.value)>-1));else{let a;switch(e.dataType){case"date":case"dateTime":case"number":a=["=","<>","<",">","<=",">=","isblank","isnotblank"];break;case"boolean":a=["=","<>","isblank","isnotblank"];break;case"object":a=["isblank","isnotblank"];break;case"string":a=["contains","notcontains","startswith","endswith","=","<>","isblank","isnotblank"];break;default:a=["contains","notcontains","startswith","endswith","=","<>","<",">","<=",">=","isblank","isnotblank"]}i=t._filterOperationDescriptions.filter((e=>a.indexOf(e.value)>-1))}return t.showIcons&&i.map((e=>e.icon=t.icons[e.value])),i}_openCustomEditor(e,t,i){const a=this,o=a.customOperations[a._selectedCustomCondition.index].editorTemplate(e,t,i);a.$.customEditor.innerHTML="",o&&a.$.customEditor.appendChild(o),a._editor=a.$.customEditor}_openEditorByFieldType(e,t,i,a){const o=this;if(e)switch(e.toLowerCase()){case"boolean":return o._initializeEditor("checkBox"),void(o._editor.checked=!!t);case"date":case"datetime":return o._initializeEditor("dateTimePicker"),o._editor.formatString="date"===e?o.formatStringDate:o.formatStringDateTime,void(o._editor.value=t);case"number":return o._initializeEditor("numericTextBox"),void(o._editor.value=t||0)}if(o._initializeEditor("input"),o._editor.dropDownWidth=o.dropDownWidth,"lookup"===e){const a=i.lookup.minLength,l=i.lookup.dataSource;if(o._editor.autoCompleteDelay=i.lookup.autoCompleteDelay||100,o._editor.dropDownAppendTo=o.$.container,o._editor.dropDownButtonPosition=o.rightToLeft?"left":"right",o._editor.minLength=isNaN(a)||null===a?1:a,o._editor.readonly=!!i.lookup.readonly,"function"==typeof l?o._editor.dataSource=l:l instanceof Promise?l.then((e=>{if(!(o._editor instanceof Smart.Input))return;const i=o._editor.opened;o._editor.dataSource=e,i&&(o._editor.open(),""===t&&o._editor.readonly&&e.length&&(o._editor.value=e[0].label||e[0]))})):o._editor.dataSource=l,"object"===e)t=JSON.stringify(t||{});else if(""===t&&o._editor.readonly){const e=o._editor.dataSource;if(Array.isArray(e)){const i=e[0];t=i&&(i.value||i.label)||""}else t=""}if(o._editor.$){const e=o._editor.$.input.dataValue;null!=e&&e===t||(o._editor.value=void 0!==t?t+"":"")}else o._editor.value=void 0!==t?t+"":""}else o._editor.dataSource=[],o._editor.dropDownButtonPosition="none",o._editor.readonly=!1,o._editor.value=void 0!==t?t+"":"";a&&"object"!==e&&o._editor.$&&(o._editor.$.input.dataValue=a)}_initializeEditor(e){const t=this;if(t.$[e+"Editor"])return void(t._editor=t.$[e+"Editor"]);const i=document.createElement("smart-"+Smart.Utilities.Core.toDash(e));"numericTextBox"===e?(i.spinButtons=!0,i.inputFormat="floatingPoint"):"dateTimePicker"===e&&(i.dropDownAppendTo=t.$.container,i.calendarButton=!0,i.dropDownDisplayMode="auto",i.enableMouseWheelAction=!0,i.locale=t.locale,i.autoClose=!0,i.messages[t.locale]||(i.messages[t.locale]={}),i.messages[t.locale].dateTabLabel=t.localize("dateTabLabel"),i.messages[t.locale].timeTabLabel=t.localize("timeTabLabel")),i.rightToLeft=t.rightToLeft,i.theme=t.theme,i.animation=t.animation,i.$.addClass("smart-hidden underlined"),t.$.editorsContainer.appendChild(i),t._editor=t.$[e+"Editor"]=i}_getValidValue(){const e=this,t=e.properties.value.value,i=[];let a=!1;return t.forEach((t=>{if(Array.isArray(t)){let o=!1,l=!1;const r=[];t.forEach((t=>{if(Array.isArray(t)){const i=t[0],a=t[1],n=t[2];if(void 0===i||void 0===a)return void(l=!0);if(void 0!==n||"isblank"===a||"isnotblank"===a)return o=!0,void r.push(t);const s=e._filterOperationDescriptions.find((e=>e.value===a));s.custom&&s.hideValue?(o=!0,r.push(t)):l=!0}else l?l=!1:r.push(t)})),o?("string"==typeof r[r.length-1]&&r.pop(),i.push(r)):a=!0}else a?a=!1:i.push(t)})),"string"==typeof i[i.length-1]&&i.pop(),i}}),Smart.Utilities.Assign("QueryParser",class{constructor(e,t,i){const a=this;a.customOperations=t||[],a.fields=e||[],a.dynamicField=i}toLinq(e){return Array.isArray(e)&&this._arePropertiesValid()?this._parseQueryToLinq(e):""}toValue(e){return"string"==typeof e&&this._arePropertiesValid()?this._parseLinqToValue(e):[]}_validateProperties(){const e=this;Array.isArray(e.customOperations)||(e.customOperations=[]),Array.isArray(e.fields)||(e.fields=[]),"function"==typeof e.dynamicField&&delete e.dynamicField}_arePropertiesValid(){return Array.isArray(this.customOperations)?!!Array.isArray(this.fields)||(console.log('Invalid "fields" property.'),!1):(console.log('Invalid "customOperations" property.'),!1)}_parseQueryToLinq(e){const t=this,i={and:"&&",or:"||"};let a="";for(let o=0;o<e.length;o++){const l=e[o];if(Array.isArray(l))if(l.indexOf("and")>-1||l.indexOf("or")>-1||1===l.length&&Array.isArray(l[0])){const e=t._parseQueryToLinq(l);e?a+=l.length>1?"("+e+")":e:/\s(&|\|){2}\s$/gm.test(a)&&(a=a.replace(/\s(&|\|){2}\s$/gm,""))}else a+=t._getExpressionFromQuery(l)||"";else a&&(a+=" "+i[l]+" ")}return a}_getExpressionFromQuery(e){const t=e[0],i=e[1];let a=e[2];const o=this.customOperations.find((e=>e.name===i));return o&&o.expressionTemplate?("string"==typeof a&&a.includes('"')&&o.expressionTemplate.includes('"')&&(a=JSON.stringify(a).slice(1,-1)),o.expressionBuilderCallback?o.expressionBuilderCallback(t,i,a):o.expressionTemplate.replace("{0}",t).replace("{1}",a)):""}_parseLinqToValue(e){const t=this;let i,a=0,o=[];for(let t=0;t<e.length;t++)if("("===e[t])a++,void 0===i&&(i=t);else if(")"===e[t]&&a>0&&(a--,0===a)){let a=e.substring(i,t+1).trim();a.length&&(a.includes("&&")||a.includes("||"))&&o.push({expr:a}),i=void 0}let l,r=[];if(o.length)for(let i=0;i<o.length;i++){let a;o[i].query=t._getQueryFromExpression(o[i].expr),a=l?e.substring(e.indexOf(l)+l.length,e.indexOf(o[i].expr)).trim():e.substring(0,e.indexOf(o[i].expr)).trim(),a&&r.push(a),l=o[i].expr}l?r.push(e.substring(e.indexOf(l)+l.length).trim()):r.push(e.trim());for(let e=0;e<r.length;e++){const i=r[e].replace(/^&{2}|^\|{2}|&{2}$|\|{2}$/gm,"").trim();i.length&&o.push({expr:i,query:t._getQueryFromExpression(i),outher:!0})}return t._constructValueFromQueries(e,o)}_getQueryFromExpression(e){const t=this,i=t.fields,a=t.dynamicField;let o=[],l=e;const r=function(e){let l=[];const r=t.customOperations.filter((e=>e.expressionTemplate));r.sort(((e,t)=>t.expressionTemplate.length-e.expressionTemplate.length));for(let t=0;t<r.length;t++){const i=r[t],a=new RegExp(i.expressionTemplate.replace(/\(/gm,"\\(").replace(/\)/gm,"\\)").replace(/\[/gm,"\\[").replace(/\]/gm,"\\]").replace(/"{\d+}"/gm,'\\W*"([^"]*)[^a-zA-Z0-9-\\s\\)]+').replace(/{\d+}/gm,"([@|$]*\\w+[.]*\\w+(?!\\s)*)\\s{0}").replace(/ /gm,"\\s"),"gm");if(a.test(e)){a.lastIndex=0;let t,o,r=a.exec(e);if(r=r.filter(((e,t)=>r.indexOf(e)===t)),i.expressionReaderCallback){let e=i.expressionReaderCallback(r[0],r.slice(1));e&&(t=e.fieldName,o=e.value)}void 0===t&&(t=r[1]||""),void 0===o&&(o=r[2]||""),l.push({operator:i.name,field:t,value:o,query:r[0]})}}let n=l.find((e=>i.find((t=>t.filterOperations.indexOf(e.operator)>-1&&t.dataField===e.field))));if(!n&&a)for(let e=0;e<l.length;e++){const t=l[e],i=a(t.field);if(i&&Array.isArray(i.filterOperations)&&i.filterOperations.indexOf(t.operator)>-1){n=t;break}}if(n)return o.push({expr:n.query,query:[n.field,n.operator,n.value]}),n.query};if(l){for(;l.length;){l&&(l=l.trim(),"("===l[0]&&")"===l[l.length-1]&&(l=l.trim().replace(/^\(|\)$/gm,"")),l=l.replace(/^&{2}|^\|{2}|&{2}$|\|{2}$/gm,"").trim());const e=r(l);if(!e)break;l=l.replace(e,"").trim()}return t._constructValueFromQueries(e,o)}}_constructValueFromQueries(e,t){let i=[];t.sort(((t,i)=>e.indexOf(t.expr)-e.indexOf(i.expr)));for(let a=0;a<t.length;a++){let o=t[a-1];if(o){const l=e.substring(e.indexOf(o.expr)+o.expr.length,e.indexOf(t[a].expr)).trim();i.push("||"===l?"or":"and")}t[a].outher?t[a].query.forEach((e=>i.push(Array.isArray(e)?[e]:e))):i.push(t[a].query)}return i}});